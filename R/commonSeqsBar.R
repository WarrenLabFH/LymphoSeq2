#' Common sequences bar plot
#' 
#' Creates an UpSetR bar plot showing the number of intersecting sequences across 
#' multiple samples.  This function is useful when more than 3 samples are being 
#' compared.
#' 
#' @param productive_aa A tibble of productive amino acid sequences 
#' generated by LymphoSeq function productiveSeq where the aggregate parameter 
#' was set to "aminoAcid".
#' @param samples The names of two or more samples in the productive_aa 
#' list whose intersections will shown.
#' @param color+sample The name of a single sample in the productive_aa list whose 
#' sequences will be colored in all samples that they appear in.
#' @param color_intersection The names of two or more samples in the productive_aa 
#' list whose intersections will be colored.
#' @param color A character vector of a color name that will be used highlight a selected 
#' sample or multiple sample intersections.
#' @param labels A character vector indicating whether the number of 
#' intersecting sequences should be shown on the tops of the bars.  Options 
#' include "yes" or "no".
#' @return Returns an UpSetR bar plot showing the number of intersecting sequences 
#' across multiple samples.
#' @examples
#' file.path <- system.file("extdata", "TCRB_sequencing", package = "LymphoSeq")
#' 
#' file.list <- readImmunoSeq(path = file.path)
#' 
#' productive.aa <- productiveSeq(file.list = file.list, aggregate = "aminoAcid")
#' 
#' commonSeqsBar(productive.aa = productive.aa, samples = c("TRB_CD4_949", "TRB_CD8_949", 
#' "TRB_Unsorted_949", "TRB_Unsorted_1320"), color.sample = "TRB_CD8_949")
#' @export
#' @import UpSetR
#' @import tidyverse
commonSeqsBar <- function(productive_aa, samples, color_sample = NULL , 
                         color_intersection = NULL, color = "#377eb8", labels = "no"){
    unique_seqs <- uniqueSeqs(productive_table = productive_aa)
    sequence_matrix <- seqMatrix(productive_aa = productive_aa, sequences = unique_seqs) 
    aminoAcid <- rownames(sequence_matrix)
    sequence_matrix = sequence_matrix[,-c(1)]
    sample_names <- colnames(sequence_matrix)
    sequence_matrix[sequence_matrix > 0] <- 1
    sequence_matrix <- sequence_matrix %>% data.frame()
    colnames(sequence_matrix) <- sample_names
    sequence_matrix <- cbind(aminoAcid, sequence_matrix) 

    if(!is.null(color_sample)){
        queryFunction = function(row, sequence) {
            data <- (row["aminoAcid"] %in% sequence)
        }
        UpSetR::upset(sequence_matrix,
              sets = samples,
              nsets = length(samples), 
              nintersects = NA,
              mainbar.y.label = "Number of intersecting sequences",
              sets.x.label = "Number of sequences",
              mb.ratio = c(0.7, 0.3),
              show.numbers = labels,
              matrix.dot.alpha = 0,
              query.legend = "bottom",
              queries = list(list(query = queryFunction, 
                                  params = list(productive_aa[[color_sample]]$aminoAcid), 
                                  color = "#377eb8",
                                  active = TRUE,
                                  query.name = color_sample)))
    } else if(!is.null(color_intersection)){
        UpSetR::upset(sequence_matrix,
              sets = samples,
              nsets = length(samples), 
              nintersects = NA,
              mainbar.y.label = "Number of intersecting sequences",
              sets.x.label = "Number of sequences",
              mb.ratio = c(0.7, 0.3),
              show.numbers = labels,
              matrix.dot.alpha = 0,
              queries = list(list(query = elements, 
                                  params = list(color_intersection), 
                                  color = color,
                                  active = TRUE)))
    } else if(is.null(color_sample) & is.null(color_intersection)){
        UpSetR::upset(sequence_matrix,
              sets = samples,
              nsets = length(samples), 
              nintersects = NA,
              mainbar.y.label = "Number of intersecting sequences",
              sets.x.label = "Number of sequences",
              mb.ratio = c(0.7, 0.3),
              show.numbers = labels,
              matrix.dot.alpha = 0)
    }
}
