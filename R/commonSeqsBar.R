#' Common sequences bar plot
#' 
#' Creates an UpSetR bar plot showing the number of intersecting sequences across 
#' multiple repertoire_ids.  This function is useful when more than 3 repertoire_ids are being 
#' compared.
#' 
#' @param productive_aa A tibble of productive amino acid sequences 
#' generated by LymphoSeq function productiveSeq where the aggregate parameter 
#' was set to "junction_aa".
#' @param repertoire_ids The names of two or more repertoire_ids in the productive_aa 
#' list whose intersections will shown.
#' @param color+repertoire_id The name of a single repertoire_id in the productive_aa list whose 
#' sequences will be colored in all repertoire_ids that they appear in.
#' @param color_intersection The names of two or more repertoire_ids in the productive_aa 
#' list whose intersections will be colored.
#' @param color A character vector of a color name that will be used highlight a selected 
#' repertoire_id or multiple repertoire_id intersections.
#' @param labels A character vector indicating whether the number of 
#' intersecting sequences should be shown on the tops of the bars.  Options 
#' include "yes" or "no".
#' @return Returns an UpSetR bar plot showing the number of intersecting sequences 
#' across multiple repertoire_ids.
#' @examples
#' file.path <- system.file("extdata", "TCRB_sequencing", package = "LymphoSeq")
#' 
#' file.list <- readImmunoSeq(path = file.path)
#' 
#' productive.aa <- productiveSeq(file.list = file.list, aggregate = "junction_aa")
#' 
#' commonSeqsBar(productive.aa = productive.aa, repertoire_ids = c("TRB_CD4_949", "TRB_CD8_949", 
#' "TRB_Unsorted_949", "TRB_Unsorted_1320"), color.repertoire_id = "TRB_CD8_949")
#' @export
#' @import UpSetR
#' @import tidyverse
commonSeqsBar <- function(productive_aa, repertoire_ids, color_sample = NULL , 
                         color_intersection = NULL, color = "#377eb8", labels = "no"){
    unique_seqs <- uniqueSeqs(productive_table = productive_aa)
    sequence_matrix <- seqMatrix(productive_aa = productive_aa, sequences = unique_seqs) 
    junction_aa <- rownames(sequence_matrix)
    sequence_matrix = sequence_matrix[,-c(1)]
    sample_names <- colnames(sequence_matrix)
    sequence_matrix[sequence_matrix > 0] <- 1
    sequence_matrix <- sequence_matrix %>% data.frame()
    colnames(sequence_matrix) <- sample_names
    sequence_matrix <- cbind(junction_aa, sequence_matrix) 

    if(!is.null(color_sample)){
        queryFunction = function(row, sequence) {
            data <- (row["junction_aa"] %in% sequence)
        }
        UpSetR::upset(sequence_matrix,
              sets = repertoire_ids,
              nsets = length(repertoire_ids), 
              nintersects = NA,
              mainbar.y.label = "Number of intersecting sequences",
              sets.x.label = "Number of sequences",
              mb.ratio = c(0.7, 0.3),
              show.numbers = labels,
              matrix.dot.alpha = 0,
              query.legend = "bottom",
              queries = list(list(query = queryFunction, 
                                  params = list(productive_aa[[color_sample]]$junction_aa), 
                                  color = "#377eb8",
                                  active = TRUE,
                                  query.name = color_sample)))
    } else if(!is.null(color_intersection)){
        UpSetR::upset(sequence_matrix,
              sets = repertoire_ids,
              nsets = length(repertoire_ids), 
              nintersects = NA,
              mainbar.y.label = "Number of intersecting sequences",
              sets.x.label = "Number of sequences",
              mb.ratio = c(0.7, 0.3),
              show.numbers = labels,
              matrix.dot.alpha = 0,
              queries = list(list(query = elements, 
                                  params = list(color_intersection), 
                                  color = color,
                                  active = TRUE)))
    } else if(is.null(color_sample) & is.null(color_intersection)){
        UpSetR::upset(sequence_matrix,
              sets = repertoire_ids,
              nsets = length(repertoire_ids), 
              nintersects = NA,
              mainbar.y.label = "Number of intersecting sequences",
              sets.x.label = "Number of sequences",
              mb.ratio = c(0.7, 0.3),
              show.numbers = labels,
              matrix.dot.alpha = 0)
    }
}
